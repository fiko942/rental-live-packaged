'use strict';const _0x206583=_0x2940;function _0x3590(){const _0x40d2a8=['MIDTRANS_SERVER_KEY','session','update','destroy','transaction','findAll','email','transactions','canceled','done','__awaiter','2976864frlyQQ','removeTransaction','moment-timezone','balance','put','description','User\x20not\x20found\x20with\x20id:\x20','application/json','5307511wVQSAj','userName','uuid','toString','change','100406lOSgPV','database','detail','default','title','alias','14yVAUsI','user','98360XzcdFW','node-fetch','apply','name','getUserName','success','POST','storage','income','20eQFVmq','Basic\x20','findOne','__esModule','env','FRONTEND_URL','afterUpdated','status','expense','37176lCGpcj','stringify','/snap/v1/transactions','165YaUwSU','StreamPEG','length','1209920QLILHU','transactionHistory','Asia/Jakarta','defineProperty','created','DESC','amount','not','push','redirect_url','Anda\x20telah\x20membuat\x20transaksi\x20beberapa\x20waktu\x20terkahir,\x20coba\x20beberapa\x20saat\x20lagi','Server\x20sedang\x20sibuk,\x20silahkan\x20coba\x20beberapa\x20saat\x20lagi:\x20','value','balanceHistory','then','userEmail','create','unix','deposit','21rFvOUq','get','token','redirectUrl','Maksimal\x203\x20transaksi\x20diabaikan\x20/\x20dibatalkan,\x20silahkan\x20dihapus\x20transaksi\x20sebelumnya\x20untuk\x20membuat\x20transaksi\x20baru','next','206613PgxOYX'];_0x3590=function(){return _0x40d2a8;};return _0x3590();}(function(_0x278daa,_0x4eebfa){const _0x347d28=_0x2940,_0xc4ac30=_0x278daa();while(!![]){try{const _0x1da885=-parseInt(_0x347d28(0x165))/0x1+parseInt(_0x347d28(0x185))/0x2+-parseInt(_0x347d28(0x146))/0x3*(-parseInt(_0x347d28(0x16d))/0x4)+parseInt(_0x347d28(0x182))/0x5*(parseInt(_0x347d28(0x17f))/0x6)+-parseInt(_0x347d28(0x16b))/0x7*(parseInt(_0x347d28(0x158))/0x8)+parseInt(_0x347d28(0x14c))/0x9*(-parseInt(_0x347d28(0x176))/0xa)+parseInt(_0x347d28(0x160))/0xb;if(_0x1da885===_0x4eebfa)break;else _0xc4ac30['push'](_0xc4ac30['shift']());}catch(_0x47ab27){_0xc4ac30['push'](_0xc4ac30['shift']());}}}(_0x3590,0x8c053));function _0x2940(_0x27aa37,_0x344a62){const _0x35906d=_0x3590();return _0x2940=function(_0x2940a2,_0x13f29a){_0x2940a2=_0x2940a2-0x144;let _0x517d6a=_0x35906d[_0x2940a2];return _0x517d6a;},_0x2940(_0x27aa37,_0x344a62);}var __awaiter=this&&this[_0x206583(0x157)]||function(_0x42e3fc,_0x1c11e4,_0x162339,_0x288df9){function _0x4e2805(_0x55408f){return _0x55408f instanceof _0x162339?_0x55408f:new _0x162339(function(_0x5af60d){_0x5af60d(_0x55408f);});}return new(_0x162339||(_0x162339=Promise))(function(_0x57ca9d,_0x570e75){const _0x33c8f0=_0x2940;function _0x1cb215(_0x523f1d){const _0x3e6be6=_0x2940;try{_0x222f8c(_0x288df9[_0x3e6be6(0x14b)](_0x523f1d));}catch(_0x2b23c8){_0x570e75(_0x2b23c8);}}function _0x225e39(_0x5731f8){try{_0x222f8c(_0x288df9['throw'](_0x5731f8));}catch(_0x3241b4){_0x570e75(_0x3241b4);}}function _0x222f8c(_0x3e56d1){const _0xefdd3a=_0x2940;_0x3e56d1[_0xefdd3a(0x156)]?_0x57ca9d(_0x3e56d1[_0xefdd3a(0x191)]):_0x4e2805(_0x3e56d1[_0xefdd3a(0x191)])[_0xefdd3a(0x193)](_0x1cb215,_0x225e39);}_0x222f8c((_0x288df9=_0x288df9[_0x33c8f0(0x16f)](_0x42e3fc,_0x1c11e4||[]))[_0x33c8f0(0x14b)]());});},__importDefault=this&&this['__importDefault']||function(_0x178a9d){return _0x178a9d&&_0x178a9d['__esModule']?_0x178a9d:{'default':_0x178a9d};};Object[_0x206583(0x188)](exports,_0x206583(0x179),{'value':!![]});const moment_timezone_1=__importDefault(require(_0x206583(0x15a))),sequelize_1=require('sequelize'),uuid_1=require(_0x206583(0x162)),node_fetch_1=__importDefault(require(_0x206583(0x16e)));class Balance{constructor({database:_0x24ad9c,session:_0x2b1cdd,storage:_0x123512}){const _0xae1b20=_0x206583;this[_0xae1b20(0x14e)]=_0x2b1cdd,this['database']=_0x24ad9c,this[_0xae1b20(0x174)]=_0x123512;}[_0x206583(0x147)](_0xedf683){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x486b1a=_0x2940,_0xf29fc5=yield this['database']['user'][_0x486b1a(0x178)]({'where':{'id':_0xedf683},'attributes':['balance']});if(!_0xf29fc5)throw new Error(_0x486b1a(0x15e)+_0xedf683);return _0xf29fc5[_0x486b1a(0x15b)];});}[_0x206583(0x14f)](_0x5046e7,_0x2acb4c){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x38119c=_0x2940;yield this[_0x38119c(0x166)][_0x38119c(0x16c)][_0x38119c(0x14f)]({'balance':_0x2acb4c},{'where':{'id':_0x5046e7}});});}[_0x206583(0x15c)](_0xf259c9){return __awaiter(this,arguments,void 0x0,function*({email:_0x30778c,id:_0x2609e5,amount:_0x33684f,type:_0x2da360,title:_0x3bcc0f,description:_0x157e92}){const _0x479af2=_0x2940;if(_0x2da360==='topup'){const _0x296b56=yield this[_0x479af2(0x166)][_0x479af2(0x151)][_0x479af2(0x178)]({'where':{'userId':_0x2609e5,'userEmail':_0x30778c,'amount':_0x33684f},'attributes':['id']});_0x296b56&&(yield this[_0x479af2(0x166)][_0x479af2(0x151)]['update']({'status':_0x479af2(0x172)},{'where':{'id':_0x296b56['id']}}),yield this[_0x479af2(0x174)]['setLimit'](_0x2609e5,0x1400));}const _0x3e4836=yield this[_0x479af2(0x147)](_0x2609e5),_0x40d20b=_0x3e4836+_0x33684f,_0x319fc8=(0x0,moment_timezone_1[_0x479af2(0x168)])()['tz'](_0x479af2(0x187));yield this[_0x479af2(0x166)][_0x479af2(0x192)][_0x479af2(0x195)]({'change':_0x33684f,'afterUpdated':_0x40d20b,'userId':_0x2609e5,'userEmail':_0x30778c,'title':_0x3bcc0f,'description':_0x157e92,'at':_0x319fc8[_0x479af2(0x144)](),'type':_0x2da360}),yield this[_0x479af2(0x14f)](_0x2609e5,_0x40d20b);});}[_0x206583(0x186)](_0x5e4c2c,_0x3590a3,_0x4d4e82){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x10c005=_0x2940;let _0x55af9f=[];const _0x4d41a5=0x1e,_0x2c229c=yield this['session'][_0x10c005(0x167)](_0x5e4c2c);let _0x19240b={'userEmail':_0x2c229c['email'],'userId':_0x2c229c['id']};if(_0x4d4e82===_0x10c005(0x17e))_0x19240b[_0x10c005(0x164)]={[sequelize_1['Op']['lt']]:0x0};else _0x4d4e82===_0x10c005(0x175)&&(_0x19240b[_0x10c005(0x164)]={[sequelize_1['Op']['gt']]:0x0});const _0x23edb2=yield this[_0x10c005(0x166)][_0x10c005(0x192)][_0x10c005(0x152)]({'where':_0x19240b,'limit':_0x4d41a5,'offset':_0x3590a3*_0x4d41a5,'order':[['at',_0x10c005(0x18a)]]});for(const _0x158741 of _0x23edb2){_0x55af9f[_0x10c005(0x18d)]({'amount':_0x158741[_0x10c005(0x164)],'balanceAfterUpdated':_0x158741[_0x10c005(0x17c)],'title':_0x158741[_0x10c005(0x169)],'description':_0x158741[_0x10c005(0x15d)],'at':_0x158741['at'],'type':_0x158741['type']});}return _0x55af9f;});}[_0x206583(0x171)](_0x2a6a0e){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x2a8a47=_0x2940,_0x1da457=yield this[_0x2a8a47(0x166)][_0x2a8a47(0x16c)][_0x2a8a47(0x178)]({'where':{'id':_0x2a6a0e},'attributes':[_0x2a8a47(0x170)]});if(!_0x1da457)throw new Error('User\x20was\x20not\x20found');return _0x1da457[_0x2a8a47(0x170)];});}[_0x206583(0x145)](_0x46d07e,_0x5ccfeb){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x8a02a3=_0x2940;if(_0x5ccfeb<0x124f8)throw new Error('Err\x20Params');const _0x1d02b1=yield this['transactions'](_0x46d07e);if(_0x1d02b1['length']>=0x3)throw new Error(_0x8a02a3(0x14a));if(_0x1d02b1[_0x8a02a3(0x184)]>0x0){const _0x153dc0=_0x1d02b1[0x0],_0x4d30fc=(0x0,moment_timezone_1[_0x8a02a3(0x168)])()['tz'](_0x8a02a3(0x187))['unix']();if(_0x4d30fc<_0x153dc0['at']+0x78)throw new Error(_0x8a02a3(0x18f));}const _0x3a023c=yield this['session'][_0x8a02a3(0x167)](_0x46d07e),_0x5bbb0b=yield this[_0x8a02a3(0x171)](_0x3a023c['id']),_0x106c86=(0x0,uuid_1['v4'])(),_0x599834=btoa(process[_0x8a02a3(0x17a)][_0x8a02a3(0x14d)]+':'),_0x3a1006=process[_0x8a02a3(0x17a)][_0x8a02a3(0x17b)]+'/app/balance',_0xf8d9ef={'transaction_details':{'order_id':_0x106c86,'gross_amount':_0x5ccfeb},'item_details':{'id':0x3ae,'price':_0x5ccfeb,'quantity':0x1,'name':_0x8a02a3(0x183)},'customer_details':{'first_name':_0x5bbb0b,'email':_0x3a023c[_0x8a02a3(0x153)]},'callbacks':{'finish':_0x3a1006,'error':_0x3a1006,'pending':_0x3a1006},'display_name':_0x8a02a3(0x183),'custom_field1':_0x3a023c['id'],'custom_field2':'StreamPEG','custom_field3':_0x3a023c[_0x8a02a3(0x153)]},_0x3c18e5=process[_0x8a02a3(0x17a)]['MIDTRANS_APP_URL']+_0x8a02a3(0x181),_0x544c9d=yield(0x0,node_fetch_1['default'])(_0x3c18e5,{'method':_0x8a02a3(0x173),'headers':{'Content-Type':'application/json','Accept':_0x8a02a3(0x15f),'Authorization':_0x8a02a3(0x177)+_0x599834},'body':JSON[_0x8a02a3(0x180)](_0xf8d9ef)});if(_0x544c9d['status']!==0xc9)throw new Error(_0x8a02a3(0x190)+_0x544c9d[_0x8a02a3(0x17d)][_0x8a02a3(0x163)]());const _0x49d73c=yield _0x544c9d['json'](),_0xddc49=(0x0,moment_timezone_1['default'])()['tz'](_0x8a02a3(0x187));return yield this[_0x8a02a3(0x166)][_0x8a02a3(0x151)][_0x8a02a3(0x195)]({'alias':_0x106c86,'userEmail':_0x3a023c[_0x8a02a3(0x153)],'userId':_0x3a023c['id'],'status':'waiting_payment','created':_0xddc49[_0x8a02a3(0x144)](),'amount':_0x5ccfeb,'userName':_0x5bbb0b,'token':_0x49d73c['token'],'redirectUrl':_0x49d73c[_0x8a02a3(0x18e)]}),{'token':_0x49d73c[_0x8a02a3(0x148)],'redirectUrl':_0x49d73c[_0x8a02a3(0x18e)],'customer':{'name':_0x5bbb0b,'email':_0x3a023c['email']},'status':'waiting_payment','id':_0x106c86,'amount':_0x5ccfeb,'at':_0xddc49[_0x8a02a3(0x144)]()};});}[_0x206583(0x154)](_0x1d38fc){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x251330=_0x2940;let _0x2de247=[];const _0x1a7cde=yield this['session'][_0x251330(0x167)](_0x1d38fc),_0x7219d9=yield this[_0x251330(0x166)]['transaction']['findAll']({'where':{'userId':_0x1a7cde['id'],'userEmail':_0x1a7cde['email'],'status':{[sequelize_1['Op'][_0x251330(0x18c)]]:_0x251330(0x172)}},'order':[[_0x251330(0x189),_0x251330(0x18a)]]});for(const _0x77bdb8 of _0x7219d9){_0x2de247[_0x251330(0x18d)]({'token':_0x77bdb8[_0x251330(0x148)],'customer':{'name':_0x77bdb8[_0x251330(0x161)],'email':_0x77bdb8[_0x251330(0x194)]},'status':_0x77bdb8[_0x251330(0x17d)],'id':_0x77bdb8[_0x251330(0x16a)],'redirectUrl':_0x77bdb8[_0x251330(0x149)],'amount':_0x77bdb8[_0x251330(0x18b)],'at':_0x77bdb8[_0x251330(0x189)]});}return _0x2de247;});}['cancelTransaction'](_0x5b2467){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x1c969a=_0x2940;yield this[_0x1c969a(0x166)]['transaction']['update']({'status':_0x1c969a(0x155)},{'where':{'alias':_0x5b2467,'status':{[sequelize_1['Op']['not']]:_0x1c969a(0x172)}}});});}[_0x206583(0x159)](_0x8a8660){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x200153=_0x2940;yield this[_0x200153(0x166)][_0x200153(0x151)][_0x200153(0x150)]({'where':{'alias':_0x8a8660,'status':{[sequelize_1['Op'][_0x200153(0x18c)]]:_0x200153(0x172)}}});});}}exports['default']=Balance;